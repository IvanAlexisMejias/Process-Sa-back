// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleKey {
  ADMIN
  DESIGNER
  FUNCTIONARY
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  RETURNED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ProblemStatus {
  OPEN
  RESOLVED
}

enum FlowHealth {
  ON_TRACK
  AT_RISK
  DELAYED
}

enum NotificationSeverity {
  INFO
  WARNING
  DANGER
}

model Role {
  id          String   @id @default(cuid())
  key         RoleKey  @unique
  name        String
  description String
  permissions RolePermission[]
  users       User[]
}

model RolePermission {
  id     String @id @default(cuid())
  roleId String
  value  String
  role   Role   @relation(fields: [roleId], references: [id])

  @@unique([roleId, value])
}

model Unit {
  id        String  @id @default(cuid())
  name      String  @unique
  parentId  String?
  leadId    String?
  parent    Unit?   @relation("UnitHierarchy", fields: [parentId], references: [id])
  children  Unit[]  @relation("UnitHierarchy")
  lead      User?   @relation("UnitLead", fields: [leadId], references: [id])
  users     User[]
  flows     FlowInstance[]
}

model User {
  id               String            @id @default(cuid())
  fullName         String
  email            String            @unique
  password         String
  avatarColor      String?
  workload         Int               @default(0)
  lastLogin        DateTime?
  roleId           String
  unitId           String?
  role             Role              @relation(fields: [roleId], references: [id])
  unit             Unit?             @relation(fields: [unitId], references: [id])
  assignedTasks    Task[]            @relation("TaskOwner")
  delegatedTasks   Task[]            @relation("TaskAssigner")
  reportedProblems TaskProblem[]     @relation("ProblemReporter")
  subtasks         SubTask[]
  stageStatuses    FlowStageStatus[]
  templates        FlowTemplate[]    @relation("TemplateOwner")
  historyEntries   TaskHistory[]     @relation("HistoryPerformer")
  notifications    Notification[]
  ledUnits         Unit[]            @relation("UnitLead")
}

model Task {
  id             String            @id @default(cuid())
  title          String
  description    String
  status         TaskStatus        @default(PENDING)
  priority       TaskPriority      @default(MEDIUM)
  ownerId        String
  assignerId     String
  flowInstanceId String?
  deadline       DateTime
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  progress       Int               @default(0)
  durationDays   Int               @default(5)
  allowRejection Boolean           @default(true)
  tags           TaskTag[]
  owner          User              @relation("TaskOwner", fields: [ownerId], references: [id])
  assigner       User              @relation("TaskAssigner", fields: [assignerId], references: [id])
  flowInstance   FlowInstance?     @relation(fields: [flowInstanceId], references: [id])
  dependencies   TaskDependency[]  @relation("TaskDependencies")
  dependents     TaskDependency[]  @relation("TaskDependents")
  subTasks       SubTask[]
  problems       TaskProblem[]
  histories      TaskHistory[]
  notifications  Notification[]
}

model TaskDependency {
  taskId      String
  dependsOnId String
  task        Task   @relation("TaskDependencies", fields: [taskId], references: [id])
  dependsOn   Task   @relation("TaskDependents", fields: [dependsOnId], references: [id])

  @@id([taskId, dependsOnId])
}

model SubTask {
  id         String     @id @default(cuid())
  title      String
  status     TaskStatus @default(PENDING)
  progress   Int        @default(0)
  deadline   DateTime
  taskId     String
  assigneeId String
  task       Task       @relation(fields: [taskId], references: [id])
  assignee   User       @relation(fields: [assigneeId], references: [id])
}

model TaskProblem {
  id          String        @id @default(cuid())
  description String
  status      ProblemStatus @default(OPEN)
  createdAt   DateTime      @default(now())
  resolvedAt  DateTime?
  taskId      String
  reporterId  String
  task        Task          @relation(fields: [taskId], references: [id])
  reporter    User          @relation("ProblemReporter", fields: [reporterId], references: [id])
}

model TaskHistory {
  id            String   @id @default(cuid())
  action        String
  notes         String?
  timestamp     DateTime @default(now())
  taskId        String
  performedById String?
  task          Task     @relation(fields: [taskId], references: [id])
  performedBy   User?    @relation("HistoryPerformer", fields: [performedById], references: [id])
}

model FlowTemplate {
  id                   String       @id @default(cuid())
  name                 String
  description          String
  businessObjective    String
  typicalDurationDays  Int
  lastUpdated          DateTime     @default(now())
  ownerId              String
  owner                User         @relation("TemplateOwner", fields: [ownerId], references: [id])
  stages               FlowStage[]
  instances            FlowInstance[]
}

model FlowStage {
  id                 String        @id @default(cuid())
  name               String
  description        String
  expectedDurationDays Int
  exitCriteria       String
  ownerRole          RoleKey
  templateId         String
  template           FlowTemplate  @relation(fields: [templateId], references: [id])
  stageStatuses      FlowStageStatus[]
}

model FlowInstance {
  id            String        @id @default(cuid())
  name          String
  kickoffDate   DateTime
  dueDate       DateTime
  health        FlowHealth    @default(ON_TRACK)
  progress      Int           @default(0)
  templateId    String
  ownerUnitId   String
  template      FlowTemplate  @relation(fields: [templateId], references: [id])
  ownerUnit     Unit          @relation(fields: [ownerUnitId], references: [id])
  stageStatuses FlowStageStatus[]
  tasks         Task[]
  notifications Notification[]
}

model FlowStageStatus {
  id          String     @id @default(cuid())
  instanceId  String
  stageId     String
  ownerId     String
  status      TaskStatus @default(PENDING)
  progress    Int        @default(0)
  instance    FlowInstance @relation(fields: [instanceId], references: [id])
  stage       FlowStage    @relation(fields: [stageId], references: [id])
  owner       User         @relation(fields: [ownerId], references: [id])

  @@unique([instanceId, stageId])
}

model Notification {
  id             String               @id @default(cuid())
  message        String
  link           String?
  severity       NotificationSeverity @default(INFO)
  createdAt      DateTime             @default(now())
  userId         String?
  taskId         String?
  flowInstanceId String?
  task           Task?                @relation(fields: [taskId], references: [id])
  flowInstance   FlowInstance?        @relation(fields: [flowInstanceId], references: [id])
  user           User?                @relation(fields: [userId], references: [id])
}
model TaskTag {
  id     String @id @default(cuid())
  taskId String
  value  String
  task   Task   @relation(fields: [taskId], references: [id])

  @@unique([taskId, value])
}
