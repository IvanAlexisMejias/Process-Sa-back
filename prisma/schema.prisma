generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String           @id @default(cuid())
  key         RoleKey          @unique
  name        String
  description String
  permissions RolePermission[]
  users       User[]
}

model RolePermission {
  id     String @id @default(cuid())
  roleId String
  value  String
  role   Role   @relation(fields: [roleId], references: [id])

  @@unique([roleId, value])
}

model Unit {
  id       String         @id @default(cuid())
  name     String         @unique
  parentId String?
  leadId   String?
  flows    FlowInstance[]
  lead     User?          @relation("UnitLead", fields: [leadId], references: [id])
  parent   Unit?          @relation("UnitHierarchy", fields: [parentId], references: [id])
  children Unit[]         @relation("UnitHierarchy")
  users    User[]
}

model User {
  id               String            @id @default(cuid())
  fullName         String
  email            String            @unique
  password         String
  avatarColor      String?
  title            String?
  phone            String?
  about            String?
  workload         Int               @default(0)
  lastLogin        DateTime?
  roleId           String
  unitId           String?
  stageStatuses    FlowStageStatus[]
  templates        FlowTemplate[]    @relation("TemplateOwner")
  notifications    Notification[]
  subtasks         SubTask[]
  delegatedTasks   Task[]            @relation("TaskAssigner")
  assignedTasks    Task[]            @relation("TaskOwner")
  historyEntries   TaskHistory[]     @relation("HistoryPerformer")
  reportedProblems TaskProblem[]     @relation("ProblemReporter")
  ledUnits         Unit[]            @relation("UnitLead")
  role             Role              @relation(fields: [roleId], references: [id])
  unit             Unit?             @relation(fields: [unitId], references: [id])
}

model Task {
  id             String           @id @default(cuid())
  title          String
  description    String
  status         TaskStatus       @default(PENDING)
  priority       TaskPriority     @default(MEDIUM)
  ownerId        String
  assignerId     String
  flowInstanceId String?
  stageStatusId  String?
  deadline       DateTime
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  progress       Int              @default(0)
  durationDays   Int              @default(5)
  allowRejection Boolean          @default(true)
  notifications  Notification[]
  subTasks       SubTask[]
  assigner       User             @relation("TaskAssigner", fields: [assignerId], references: [id])
  flowInstance   FlowInstance?    @relation(fields: [flowInstanceId], references: [id])
  owner          User             @relation("TaskOwner", fields: [ownerId], references: [id])
  dependents     TaskDependency[] @relation("TaskDependents")
  dependencies   TaskDependency[] @relation("TaskDependencies")
  histories      TaskHistory[]
  problems       TaskProblem[]
  tags           TaskTag[]
  stageStatus    FlowStageStatus? @relation(fields: [stageStatusId], references: [id])
}

model TaskDependency {
  taskId      String
  dependsOnId String
  dependsOn   Task   @relation("TaskDependents", fields: [dependsOnId], references: [id])
  task        Task   @relation("TaskDependencies", fields: [taskId], references: [id])

  @@id([taskId, dependsOnId])
}

model SubTask {
  id         String     @id @default(cuid())
  title      String
  status     TaskStatus @default(PENDING)
  progress   Int        @default(0)
  deadline   DateTime
  taskId     String
  assigneeId String
  assignee   User       @relation(fields: [assigneeId], references: [id])
  task       Task       @relation(fields: [taskId], references: [id])
}

model TaskProblem {
  id          String        @id @default(cuid())
  description String
  status      ProblemStatus @default(OPEN)
  createdAt   DateTime      @default(now())
  resolvedAt  DateTime?
  resolution  String?
  taskId      String
  reporterId  String
  reporter    User          @relation("ProblemReporter", fields: [reporterId], references: [id])
  task        Task          @relation(fields: [taskId], references: [id])
}

model TaskHistory {
  id            String   @id @default(cuid())
  action        String
  notes         String?
  timestamp     DateTime @default(now())
  taskId        String
  performedById String?
  performedBy   User?    @relation("HistoryPerformer", fields: [performedById], references: [id])
  task          Task     @relation(fields: [taskId], references: [id])
}

model FlowTemplate {
  id                  String         @id @default(cuid())
  name                String
  description         String
  businessObjective   String
  typicalDurationDays Int
  lastUpdated         DateTime       @default(now())
  ownerId             String
  instances           FlowInstance[]
  stages              FlowStage[]
  owner               User           @relation("TemplateOwner", fields: [ownerId], references: [id])
}

model FlowStage {
  id                   String            @id @default(cuid())
  name                 String
  description          String
  expectedDurationDays Int
  exitCriteria         String
  ownerRole            RoleKey
  templateId           String
  template             FlowTemplate      @relation(fields: [templateId], references: [id])
  stageStatuses        FlowStageStatus[]
}

model FlowInstance {
  id            String            @id @default(cuid())
  name          String
  kickoffDate   DateTime
  dueDate       DateTime
  health        FlowHealth        @default(ON_TRACK)
  progress      Int               @default(0)
  templateId    String
  ownerUnitId   String
  ownerUnit     Unit              @relation(fields: [ownerUnitId], references: [id])
  template      FlowTemplate      @relation(fields: [templateId], references: [id])
  stageStatuses FlowStageStatus[]
  notifications Notification[]
  tasks         Task[]
}

model FlowStageStatus {
  id         String       @id @default(cuid())
  instanceId String
  stageId    String
  ownerId    String
  status     TaskStatus   @default(PENDING)
  progress   Int          @default(0)
  instance   FlowInstance @relation(fields: [instanceId], references: [id])
  owner      User         @relation(fields: [ownerId], references: [id])
  stage      FlowStage    @relation(fields: [stageId], references: [id])
  tasks      Task[]

  @@unique([instanceId, stageId])
}

model Notification {
  id             String               @id @default(cuid())
  message        String
  link           String?
  severity       NotificationSeverity @default(INFO)
  createdAt      DateTime             @default(now())
  userId         String?
  taskId         String?
  flowInstanceId String?
  flowInstance   FlowInstance?        @relation(fields: [flowInstanceId], references: [id])
  task           Task?                @relation(fields: [taskId], references: [id])
  user           User?                @relation(fields: [userId], references: [id])
}

model TaskTag {
  id     String @id @default(cuid())
  taskId String
  value  String
  task   Task   @relation(fields: [taskId], references: [id])

  @@unique([taskId, value])
}

enum RoleKey {
  ADMIN
  DESIGNER
  FUNCTIONARY
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  RETURNED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ProblemStatus {
  OPEN
  RESOLVED
}

enum FlowHealth {
  ON_TRACK
  AT_RISK
  DELAYED
}

enum NotificationSeverity {
  INFO
  WARNING
  DANGER
}
